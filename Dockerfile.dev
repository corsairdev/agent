FROM node:22-slim

# Build tools required by @whiskeysockets/baileys (native modules)
RUN apt-get update && apt-get install -y \
    build-essential \
    python3 \
    git \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g pnpm

WORKDIR /app

# Install dependencies in a separate layer so Docker caches it.
# This layer only rebuilds when package.json or pnpm-lock.yaml changes.
COPY package.json pnpm-lock.yaml ./
RUN pnpm install

# Give the node user ownership of app files (including node_modules named volume).
RUN chown -R node:node /app

# Pre-create Claude config so the SDK subprocess can write to it.
RUN mkdir -p /home/node/.claude && echo '{}' > /home/node/.claude.json && chown -R node:node /home/node

# Switch to non-root user (required for --dangerously-skip-permissions).
USER node

# Source code is NOT copied here â€” it's mounted at runtime via docker-compose.
# Edits on the host are reflected immediately inside the container.
